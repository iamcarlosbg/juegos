<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multijugador â€” Juegos Educativos en Tiempo Real | Aprende y Juega</title>
    <meta name="description" content="Compite en juegos educativos de matemÃ¡ticas contra otros jugadores en tiempo real. Mismas operaciones, mismo tiempo. Â¿QuiÃ©n es mÃ¡s rÃ¡pido?">
    <meta property="og:title" content="Modo Multijugador â€” Aprende y Juega">
    <meta property="og:description" content="Compite en juegos educativos contra otros jugadores en tiempo real.">
    <meta property="og:url" content="https://aprendeyjuega.com/multiplayer-lobby.html">
    <meta property="og:image" content="https://aprendeyjuega.com/imagenes/preview-academia.png">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="canonical" href="https://aprendeyjuega.com/multiplayer-lobby.html">
    <meta name="theme-color" content="#EA580C">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase: App + Firestore (existente) + Realtime DB (nuevo) -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="config.js"></script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F5E13E7QHY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-F5E13E7QHY');
    </script>

    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.9); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.5; }
            100% { transform: scale(0.9); opacity: 1; }
        }
        .pulse-ring { animation: pulse-ring 2s ease-in-out infinite; }
        
        @keyframes searching-dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .searching::after {
            content: '';
            animation: searching-dots 1.5s infinite steps(1);
        }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-up { animation: slide-up 0.4s ease-out forwards; }
        
        .game-option { transition: all 0.25s ease; }
        .game-option:hover { transform: translateY(-4px); }
        .game-option.selected { 
            ring: 4px;
            transform: scale(1.03);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-orange-400 via-red-400 to-pink-500">

    <!-- Banner Beta -->
    <div id="dev-banner" style="display:none;" class="bg-yellow-400 text-black text-center py-2 font-bold text-sm">
        âš ï¸ MODO MULTIJUGADOR EN PRUEBAS
    </div>

    <div class="container mx-auto px-4 py-6 max-w-4xl">

        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <a href="index.html" class="bg-white/90 text-orange-600 px-4 py-2 rounded-xl font-bold hover:bg-white transition shadow-lg text-sm">
                ğŸ  Inicio
            </a>
            <h1 class="text-2xl md:text-3xl font-bold text-white drop-shadow-lg text-center">
                ğŸ‘¥ Multijugador
            </h1>
            <div class="w-20"></div>
        </div>

        <!-- â•â•â• PANTALLA 1: SELECCIÃ“N DE JUEGO â•â•â• -->
        <div id="screen-select" class="slide-up">
            
            <!-- Paso 1: Materia -->
            <div class="bg-white/95 backdrop-blur rounded-2xl p-6 shadow-xl mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    1ï¸âƒ£ Elige la materia
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="subject-grid">
                    <button onclick="selectSubject('matematicas')" data-subject="matematicas" 
                            class="game-option bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl p-4 text-center">
                        <div class="text-4xl mb-2">ğŸ”¢</div>
                        <div class="font-bold text-blue-700 text-sm">MatemÃ¡ticas</div>
                    </button>
                    <button onclick="selectSubject('lengua')" data-subject="lengua"
                            class="game-option bg-green-50 hover:bg-green-100 border-2 border-green-200 rounded-xl p-4 text-center">
                        <div class="text-4xl mb-2">ğŸ“–</div>
                        <div class="font-bold text-green-700 text-sm">Lengua</div>
                    </button>
                    <button onclick="selectSubject('logica')" data-subject="logica"
                            class="game-option bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-xl p-4 text-center">
                        <div class="text-4xl mb-2">ğŸ§©</div>
                        <div class="font-bold text-purple-700 text-sm">LÃ³gica</div>
                    </button>
                    <button onclick="selectSubject('mecanografia')" data-subject="mecanografia"
                            class="game-option bg-orange-50 hover:bg-orange-100 border-2 border-orange-200 rounded-xl p-4 text-center">
                        <div class="text-4xl mb-2">âŒ¨ï¸</div>
                        <div class="font-bold text-orange-700 text-sm">MecanografÃ­a</div>
                    </button>
                </div>
            </div>

            <!-- Paso 2: Juego (aparece tras elegir materia) -->
            <div id="step-game" class="bg-white/95 backdrop-blur rounded-2xl p-6 shadow-xl mb-6 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    2ï¸âƒ£ Elige el juego
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="game-grid">
                    <!-- Se rellena dinÃ¡micamente -->
                </div>
            </div>

            <!-- Paso 3: Dificultad (aparece tras elegir juego) -->
            <div id="step-difficulty" class="bg-white/95 backdrop-blur rounded-2xl p-6 shadow-xl mb-6 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    3ï¸âƒ£ Elige la dificultad
                </h2>
                <div class="grid grid-cols-3 gap-3" id="difficulty-grid">
                    <button onclick="selectDifficulty('facil')" data-diff="facil"
                            class="game-option bg-green-50 hover:bg-green-100 border-2 border-green-200 rounded-xl p-4 text-center">
                        <div class="text-3xl mb-1">ğŸ˜Š</div>
                        <div class="font-bold text-green-700">FÃ¡cil</div>
                    </button>
                    <button onclick="selectDifficulty('medio')" data-diff="medio"
                            class="game-option bg-yellow-50 hover:bg-yellow-100 border-2 border-yellow-200 rounded-xl p-4 text-center">
                        <div class="text-3xl mb-1">ğŸ¤”</div>
                        <div class="font-bold text-yellow-700">Medio</div>
                    </button>
                    <button onclick="selectDifficulty('dificil')" data-diff="dificil"
                            class="game-option bg-red-50 hover:bg-red-100 border-2 border-red-200 rounded-xl p-4 text-center">
                        <div class="text-3xl mb-1">ğŸ”¥</div>
                        <div class="font-bold text-red-700">DifÃ­cil</div>
                    </button>
                </div>
            </div>

            <!-- Paso 4: Nombre -->
            <div id="step-name" class="bg-white/95 backdrop-blur rounded-2xl p-6 shadow-xl mb-6 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">
                    4ï¸âƒ£ Tu nombre
                </h2>
                <div class="flex gap-3 max-w-md mx-auto">
                    <input type="text" id="player-name" maxlength="15" placeholder="Escribe tu nombre..."
                           class="flex-1 px-4 py-3 border-2 border-orange-300 rounded-xl text-lg font-bold text-center focus:outline-none focus:border-orange-500"
                           onkeydown="if(event.key==='Enter') joinQueue()">
                    <button onclick="joinQueue()" id="btn-search"
                            class="bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold px-6 py-3 rounded-xl text-lg hover:from-orange-600 hover:to-red-600 transition shadow-lg">
                        ğŸ” Buscar
                    </button>
                </div>
            </div>
        </div>

        <!-- â•â•â• PANTALLA 2: BUSCANDO OPONENTE â•â•â• -->
        <div id="screen-searching" class="hidden">
            <div class="bg-white/95 backdrop-blur rounded-2xl p-8 shadow-xl text-center">
                
                <div class="pulse-ring inline-block mb-6">
                    <div class="w-32 h-32 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-6xl">ğŸ‘¥</span>
                    </div>
                </div>
                
                <h2 class="text-2xl font-bold text-gray-800 mb-2">
                    <span class="searching">Buscando oponente</span>
                </h2>
                
                <p class="text-gray-500 mb-2" id="search-info">
                    <!-- Se rellena dinÃ¡micamente -->
                </p>
                
                <p class="text-gray-400 text-sm mb-6" id="search-timer">
                    Tiempo buscando: <span id="search-seconds">0</span>s
                </p>

                <button onclick="cancelSearch()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold px-6 py-3 rounded-xl transition">
                    âœ• Cancelar
                </button>
            </div>
        </div>

        <!-- â•â•â• PANTALLA 3: Â¡OPONENTE ENCONTRADO! â•â•â• -->
        <div id="screen-matched" class="hidden">
            <div class="bg-white/95 backdrop-blur rounded-2xl p-8 shadow-xl text-center">
                
                <div class="text-5xl mb-4">âš¡</div>
                
                <h2 class="text-3xl font-bold text-gray-800 mb-4">
                    Â¡Oponente encontrado!
                </h2>
                
                <div class="flex items-center justify-center gap-6 mb-6">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                            <span class="text-3xl">ğŸ§‘</span>
                        </div>
                        <p class="font-bold text-gray-800" id="match-player1">TÃº</p>
                    </div>
                    
                    <div class="text-4xl font-black text-orange-500">VS</div>
                    
                    <div class="text-center">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2">
                            <span class="text-3xl">ğŸ§‘</span>
                        </div>
                        <p class="font-bold text-gray-800" id="match-player2">Oponente</p>
                    </div>
                </div>
                
                <p class="text-xl text-gray-600 mb-2">La partida empieza en...</p>
                <p class="text-5xl font-black text-orange-500" id="countdown">3</p>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-6 mt-8">
      <div class="max-w-6xl mx-auto px-4">
        <div class="text-center text-sm text-gray-400 mb-2">
          <a href="index.html" class="hover:text-white transition mx-2">Inicio</a>
          <span>|</span>
          <a href="materias.html" class="hover:text-white transition mx-2">Materias</a>
          <span>|</span>
          <a href="puntuaciones.html" class="hover:text-white transition mx-2">Puntuaciones</a>
        </div>
        <div class="text-center text-sm text-gray-500">
          Â© <span id="year"></span> Aprende y Juega ğŸ“
        </div>
      </div>
    </footer>

    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MULTIPLAYER LOBBY â€” LÃ³gica completa
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ CatÃ¡logo de juegos multijugador â”€â”€
    var MULTIPLAYER_GAMES = {
      matematicas: [
        { id: 'invasores-matematicos', name: 'Invasores MatemÃ¡ticos', emoji: 'ğŸ‘¾', desc: 'Resuelve operaciones rÃ¡pidamente' },
        { id: 'jerarquia-operaciones', name: 'JerarquÃ­a Operaciones', emoji: 'ğŸ§®', desc: 'Orden correcto de operaciones' },
        { id: 'mayor-menor', name: 'Mayor o Menor', emoji: 'âš–ï¸', desc: 'Compara nÃºmeros y operaciones' },
        { id: 'completa-numero', name: 'Completa el NÃºmero', emoji: 'ğŸ”¢', desc: 'Encuentra el nÃºmero que falta' }
      ],
      lengua: [
        { id: 'sopa-letras', name: 'Sopa de Letras', emoji: 'ğŸ”¤', desc: 'Encuentra las palabras escondidas' },
        { id: 'completa-letra', name: 'Completa la Letra', emoji: 'âœï¸', desc: 'Completa la palabra con la letra correcta' }
      ],
      logica: [
        { id: 'seguir-patrones', name: 'Seguir Patrones', emoji: 'ğŸ§©', desc: 'Memoriza y repite secuencias' }
      ],
      mecanografia: [
        { id: 'practica-escritura', name: 'PrÃ¡ctica de Escritura', emoji: 'âŒ¨ï¸', desc: 'Escribe frases correctamente' }
      ]
    };

    // â”€â”€ Estado del lobby â”€â”€
    var lobbyState = {
      subject: null,
      game: null,
      difficulty: null,
      playerName: null,
      playerId: null,
      searchTimer: null,
      searchSeconds: 0,
      queueRef: null,
      assignRef: null,
      matchListener: null
    };

    // â”€â”€ Firebase RTDB â”€â”€
    var rtdb = null;

    // â•â•â• INICIALIZACIÃ“N â•â•â•
    window.addEventListener('load', function() {
      // Verificar feature flag
      if (!isFeatureEnabled('multiplayer')) {
        document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center bg-gray-100"><div class="text-center p-8"><div class="text-6xl mb-4">ğŸ”’</div><h1 class="text-2xl font-bold text-gray-800 mb-2">Modo Multijugador</h1><p class="text-gray-600 mb-4">Este modo aÃºn no estÃ¡ disponible.</p><a href="index.html" class="bg-orange-500 text-white px-6 py-3 rounded-xl font-bold">Volver al inicio</a></div></div>';
        return;
      }

      // Inicializar Firebase RTDB
      try {
        var app = firebase.app(); // Ya inicializada por firebase-config.js
        rtdb = firebase.database();
        console.log('âœ… Firebase RTDB inicializado');
      } catch (e) {
        console.error('âŒ Error inicializando RTDB:', e);
      }

      // Dev banner
      if (isFeatureEnabled('showDevBanner')) {
        document.getElementById('dev-banner').style.display = 'block';
      }

      // Recuperar nombre si existe
      var savedName = sessionStorage.getItem('mp_playerName');
      if (savedName) {
        document.getElementById('player-name').value = savedName;
      }
    });

    // â•â•â• PASO 1: SELECCIONAR MATERIA â•â•â•
    function selectSubject(subject) {
      lobbyState.subject = subject;
      lobbyState.game = null;
      lobbyState.difficulty = null;

      // Highlight
      document.querySelectorAll('#subject-grid button').forEach(function(btn) {
        btn.classList.remove('ring-4', 'ring-orange-400', 'scale-105', 'bg-orange-50');
        btn.classList.add('border-2');
      });
      var selected = document.querySelector('[data-subject="' + subject + '"]');
      selected.classList.add('ring-4', 'ring-orange-400', 'scale-105');

      // Mostrar juegos
      var games = MULTIPLAYER_GAMES[subject] || [];
      var grid = document.getElementById('game-grid');
      grid.innerHTML = games.map(function(g) {
        return '<button onclick="selectGame(\'' + g.id + '\')" data-game="' + g.id + '" ' +
               'class="game-option bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 rounded-xl p-4 text-left flex items-center gap-3">' +
               '<span class="text-3xl">' + g.emoji + '</span>' +
               '<div><div class="font-bold text-gray-800">' + g.name + '</div>' +
               '<div class="text-sm text-gray-500">' + g.desc + '</div></div></button>';
      }).join('');

      document.getElementById('step-game').classList.remove('hidden');
      document.getElementById('step-game').classList.add('slide-up');
      document.getElementById('step-difficulty').classList.add('hidden');
      document.getElementById('step-name').classList.add('hidden');
    }

    // â•â•â• PASO 2: SELECCIONAR JUEGO â•â•â•
    function selectGame(gameId) {
      lobbyState.game = gameId;
      lobbyState.difficulty = null;

      // Highlight
      document.querySelectorAll('#game-grid button').forEach(function(btn) {
        btn.classList.remove('ring-4', 'ring-orange-400', 'scale-105');
      });
      var selected = document.querySelector('[data-game="' + gameId + '"]');
      if (selected) selected.classList.add('ring-4', 'ring-orange-400', 'scale-105');

      document.getElementById('step-difficulty').classList.remove('hidden');
      document.getElementById('step-difficulty').classList.add('slide-up');
      document.getElementById('step-name').classList.add('hidden');
    }

    // â•â•â• PASO 3: SELECCIONAR DIFICULTAD â•â•â•
    function selectDifficulty(diff) {
      lobbyState.difficulty = diff;

      // Highlight
      document.querySelectorAll('#difficulty-grid button').forEach(function(btn) {
        btn.classList.remove('ring-4', 'ring-orange-400', 'scale-105');
      });
      var selected = document.querySelector('[data-diff="' + diff + '"]');
      if (selected) selected.classList.add('ring-4', 'ring-orange-400', 'scale-105');

      document.getElementById('step-name').classList.remove('hidden');
      document.getElementById('step-name').classList.add('slide-up');
      document.getElementById('player-name').focus();
    }

    // â•â•â• PASO 4: UNIRSE A LA COLA â•â•â•
    function joinQueue() {
      var name = document.getElementById('player-name').value.trim();
      if (!name) {
        document.getElementById('player-name').classList.add('border-red-500');
        document.getElementById('player-name').placeholder = 'Â¡Escribe tu nombre!';
        return;
      }
      if (!rtdb) {
        alert('Error: Firebase no estÃ¡ disponible. Recarga la pÃ¡gina.');
        return;
      }

      lobbyState.playerName = name.substring(0, 15).toUpperCase();
      lobbyState.playerId = 'PLY_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

      // Guardar nombre para futuras sesiones
      sessionStorage.setItem('mp_playerName', lobbyState.playerName);

      // Mostrar pantalla de bÃºsqueda
      document.getElementById('screen-select').classList.add('hidden');
      document.getElementById('screen-searching').classList.remove('hidden');
      document.getElementById('search-info').textContent = 
        lobbyState.game + ' Â· ' + lobbyState.difficulty;

      // Iniciar timer visual
      lobbyState.searchSeconds = 0;
      lobbyState.searchTimer = setInterval(function() {
        lobbyState.searchSeconds++;
        document.getElementById('search-seconds').textContent = lobbyState.searchSeconds;
      }, 1000);

      // Conectar a Firebase RTDB
      var queueKey = lobbyState.game + '_' + lobbyState.difficulty;
      var queuePath = 'matchmaking/queue/' + queueKey;

      // 1. AÃ±adirme a la cola
      lobbyState.queueRef = rtdb.ref(queuePath + '/' + lobbyState.playerId);
      lobbyState.queueRef.set({
        name: lobbyState.playerName,
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        subject: lobbyState.subject,
        game: lobbyState.game,
        difficulty: lobbyState.difficulty
      });

      // Auto-eliminar si se desconecta
      lobbyState.queueRef.onDisconnect().remove();

      // 2. Escuchar la cola â€” Â¿hay 2 jugadores?
      var queueListRef = rtdb.ref(queuePath);
      lobbyState.matchListener = queueListRef.on('value', function(snapshot) {
        var players = snapshot.val();
        if (!players) return;

        var playerIds = Object.keys(players);
        if (playerIds.length >= 2) {
          // Ordenar por tiempo de llegada
          var sorted = playerIds.sort(function(a, b) {
            return (players[a].joinedAt || 0) - (players[b].joinedAt || 0);
          });

          // El primero crea la partida
          if (sorted[0] === lobbyState.playerId) {
            createMatch(sorted[0], sorted[1], players[sorted[0]], players[sorted[1]], queuePath);
          }
        }
      });

      // 3. Escuchar si me asignan un match
      lobbyState.assignRef = rtdb.ref('matchmaking/assignments/' + lobbyState.playerId);
      lobbyState.assignRef.on('value', function(snapshot) {
        var matchId = snapshot.val();
        if (matchId) {
          onMatchFound(matchId);
        }
      });
      lobbyState.assignRef.onDisconnect().remove();

      // Analytics
      if (typeof gtag === 'function') {
        gtag('event', 'multiplayer_queue_join', {
          'game': lobbyState.game,
          'difficulty': lobbyState.difficulty
        });
      }
    }

    // â•â•â• CREAR PARTIDA â•â•â•
    function createMatch(hostId, guestId, hostData, guestData, queuePath) {
      var matchId = 'M_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);

      // Generar operaciones (mismas para ambos)
      var operations = generateOperationsForGame(lobbyState.game, lobbyState.difficulty, 20);

      var matchData = {
        matchId: matchId,
        players: {},
        operations: operations,
        config: {
          subject: lobbyState.subject,
          game: lobbyState.game,
          difficulty: lobbyState.difficulty,
          totalOperations: operations.length,
          timeLimitSeconds: 120
        },
        status: 'active',
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        startedAt: null,
        finishedAt: null
      };

      matchData.players[hostId] = {
        name: hostData.name,
        score: 0,
        current: 0,
        finished: false,
        answers: {}
      };
      matchData.players[guestId] = {
        name: guestData.name,
        score: 0,
        current: 0,
        finished: false,
        answers: {}
      };

      // ActualizaciÃ³n atÃ³mica: crear match + limpiar cola + asignar
      var updates = {};
      updates['matches/' + matchId] = matchData;
      updates[queuePath + '/' + hostId] = null;
      updates[queuePath + '/' + guestId] = null;
      updates['matchmaking/assignments/' + hostId] = matchId;
      updates['matchmaking/assignments/' + guestId] = matchId;

      rtdb.ref().update(updates).then(function() {
        console.log('âœ… Match creado:', matchId);
      }).catch(function(err) {
        console.error('âŒ Error creando match:', err);
      });
    }

    // â•â•â• MATCH ENCONTRADO â•â•â•
    function onMatchFound(matchId) {
      // Detener bÃºsqueda
      clearInterval(lobbyState.searchTimer);
      if (lobbyState.matchListener) {
        // Clean up listener
      }

      // Guardar datos en sessionStorage para la pÃ¡gina de juego
      sessionStorage.setItem('mp_matchId', matchId);
      sessionStorage.setItem('mp_playerId', lobbyState.playerId);
      sessionStorage.setItem('mp_playerName', lobbyState.playerName);
      sessionStorage.setItem('mp_game', lobbyState.game);

      // Leer datos del match para mostrar al oponente
      rtdb.ref('matches/' + matchId).once('value').then(function(snapshot) {
        var match = snapshot.val();
        if (!match) return;

        // Mostrar pantalla de "match found"
        document.getElementById('screen-searching').classList.add('hidden');
        document.getElementById('screen-matched').classList.remove('hidden');

        // Nombres
        var players = match.players;
        var opponentName = '';
        Object.keys(players).forEach(function(pid) {
          if (pid === lobbyState.playerId) {
            document.getElementById('match-player1').textContent = players[pid].name;
          } else {
            opponentName = players[pid].name;
            document.getElementById('match-player2').textContent = opponentName;
          }
        });

        // Cuenta atrÃ¡s 3-2-1
        var count = 3;
        var countdownEl = document.getElementById('countdown');
        var countdownTimer = setInterval(function() {
          count--;
          if (count > 0) {
            countdownEl.textContent = count;
          } else {
            clearInterval(countdownTimer);
            countdownEl.textContent = 'Â¡GO!';
            // Redirigir al juego multijugador
            setTimeout(function() {
              window.location.href = 'multiplayer-game.html?match=' + matchId + '&player=' + lobbyState.playerId;
            }, 500);
          }
        }, 1000);
      });

      // Analytics
      if (typeof gtag === 'function') {
        gtag('event', 'multiplayer_match_found', {
          'game': lobbyState.game,
          'search_time': lobbyState.searchSeconds
        });
      }
    }

    // â•â•â• CANCELAR BÃšSQUEDA â•â•â•
    function cancelSearch() {
      clearInterval(lobbyState.searchTimer);

      // Eliminar de la cola
      if (lobbyState.queueRef) {
        lobbyState.queueRef.remove();
      }
      if (lobbyState.assignRef) {
        lobbyState.assignRef.off();
        lobbyState.assignRef.remove();
      }

      // Volver a pantalla de selecciÃ³n
      document.getElementById('screen-searching').classList.add('hidden');
      document.getElementById('screen-select').classList.remove('hidden');
    }

    // â•â•â• GENERADOR DE OPERACIONES â•â•â•
    function generateOperationsForGame(game, difficulty, count) {
      var operations = [];
      
      for (var i = 0; i < count; i++) {
        var op = null;

        switch(game) {
          case 'invasores-matematicos':
          case 'jerarquia-operaciones':
          case 'completa-numero':
            op = generateMathOperation(difficulty);
            break;
          case 'mayor-menor':
            op = generateMayorMenor(difficulty);
            break;
          case 'sopa-letras':
          case 'completa-letra':
            op = generateLanguageQuestion(difficulty, i);
            break;
          case 'seguir-patrones':
            op = generatePatternQuestion(difficulty, i);
            break;
          case 'practica-escritura':
            op = generateTypingQuestion(difficulty, i);
            break;
          default:
            op = generateMathOperation(difficulty);
        }

        op.id = i + 1;
        operations.push(op);
      }

      return operations;
    }

    // â”€â”€ MatemÃ¡ticas â”€â”€
    function generateMathOperation(difficulty) {
      var range, ops;
      if (difficulty === 'facil') {
        range = 9; ops = ['suma', 'resta'];
      } else if (difficulty === 'medio') {
        range = 50; ops = ['suma', 'resta', 'multiplicar'];
      } else {
        range = 99; ops = ['suma', 'resta', 'multiplicar'];
      }

      var opType = ops[Math.floor(Math.random() * ops.length)];
      var a, b, answer, text;

      if (opType === 'suma') {
        a = Math.floor(Math.random() * range) + 1;
        b = Math.floor(Math.random() * range) + 1;
        answer = a + b;
        text = a + ' + ' + b;
      } else if (opType === 'resta') {
        a = Math.floor(Math.random() * range) + 1;
        b = Math.floor(Math.random() * a) + 1;
        answer = a - b;
        text = a + ' - ' + b;
      } else {
        a = Math.floor(Math.random() * 10) + 1;
        b = Math.floor(Math.random() * 10) + 1;
        answer = a * b;
        text = a + ' Ã— ' + b;
      }

      return { type: 'math', text: text + ' = ?', answer: answer };
    }

    // â”€â”€ Mayor/Menor â”€â”€
    function generateMayorMenor(difficulty) {
      var range = difficulty === 'facil' ? 20 : difficulty === 'medio' ? 50 : 100;
      var left = Math.floor(Math.random() * range) + 1;
      var right = Math.floor(Math.random() * range) + 1;
      // Asegurar que no sean iguales el 80% de las veces
      if (Math.random() > 0.2 && left === right) {
        right = left + Math.floor(Math.random() * 5) + 1;
      }
      var answer = left > right ? '>' : left < right ? '<' : '=';
      return { type: 'compare', left: left, right: right, text: left + ' ___ ' + right, answer: answer };
    }

    // â”€â”€ Lengua (simplificado para multijugador) â”€â”€
    function generateLanguageQuestion(difficulty, index) {
      var words = ['GATO','CASA','PERRO','MESA','LUNA','SILLA','SOL','MAR','FLOR','ARBOL',
                   'LIBRO','CIELO','AGUA','FUEGO','TIERRA','ESTRELLA','NUBE','ROCA','VIENTO','LUZ',
                   'MONTE','PLAYA','BOSQUE','CAMPO','PUENTE','CAMINO','TORRE','BARCO','AVION','TREN'];
      var word = words[(index * 7 + 3) % words.length]; // Determinista para ambos jugadores
      var hideIndex = Math.floor(Math.random() * word.length);
      // Usar seed basado en index para que sea igual
      hideIndex = (index * 3 + 1) % word.length;
      var display = word.substring(0, hideIndex) + '_' + word.substring(hideIndex + 1);
      return { type: 'letter', text: display, answer: word[hideIndex], fullWord: word };
    }

    // â”€â”€ Patrones (simplificado) â”€â”€
    function generatePatternQuestion(difficulty, index) {
      var colors = ['ğŸ”´','ğŸ”µ','ğŸŸ¢','ğŸŸ¡','ğŸŸ£','ğŸŸ '];
      var len = difficulty === 'facil' ? 3 : difficulty === 'medio' ? 4 : 5;
      var pattern = [];
      // Seed determinista
      var seed = index * 17 + 42;
      for (var j = 0; j < len; j++) {
        pattern.push(colors[(seed + j * 13) % colors.length]);
      }
      // La respuesta es el siguiente en la secuencia (repeticiÃ³n)
      var answer = pattern[0];
      return { type: 'pattern', sequence: pattern, text: pattern.join(' ') + ' â†’ ?', answer: answer };
    }

    // â”€â”€ Escritura (simplificado) â”€â”€
    function generateTypingQuestion(difficulty, index) {
      var phrases = {
        facil: ['El sol brilla hoy', 'Mi gato duerme', 'La luna es bonita', 'El perro corre', 'Hoy es un buen dÃ­a',
                'Me gusta jugar', 'El cielo es azul', 'La flor es roja', 'El agua estÃ¡ frÃ­a', 'Yo como fruta'],
        medio: ['Los pÃ¡jaros cantan en el Ã¡rbol', 'Mi hermana lee un libro grande', 'El mar tiene olas enormes',
                'Jugamos en el parque con amigos', 'La profesora explica la lecciÃ³n', 'El tren llega a las ocho',
                'Necesito un lÃ¡piz y una goma', 'MaÃ±ana vamos de excursiÃ³n', 'El viento mueve las hojas', 'Estudiamos para el examen'],
        dificil: ['La biblioteca municipal cierra los domingos por la tarde',
                  'Los cientÃ­ficos descubrieron una nueva especie marina',
                  'El campeonato internacional de ajedrez comienza maÃ±ana',
                  'La temperatura ha descendido considerablemente esta semana',
                  'El restaurante ofrece platos vegetarianos muy sabrosos']
      };
      var list = phrases[difficulty] || phrases.facil;
      var phrase = list[index % list.length];
      return { type: 'typing', text: phrase, answer: phrase };
    }

    // â•â•â• LIMPIEZA AL SALIR â•â•â•
    window.addEventListener('beforeunload', function() {
      if (lobbyState.queueRef) {
        lobbyState.queueRef.remove();
      }
      if (lobbyState.assignRef) {
        lobbyState.assignRef.remove();
      }
    });
    </script>

</body>
</html>
